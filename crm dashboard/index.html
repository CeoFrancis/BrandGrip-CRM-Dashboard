<!DOCTYPE html>
<html>
<head>
  <title>External CRM Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Add the custom styles from the previous version here */
    body {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .custom-scroll::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scroll::-webkit-scrollbar-thumb {
        background-color: #cbd5e1; /* slate-300 */
        border-radius: 4px;
    }
    .custom-scroll {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f8fafc; /* slate-300 track */
    }
  </style>
</head>
<body class="bg-gray-50 p-4 custom-scroll min-h-screen">

  <div class="max-w-7xl mx-auto">
    <header class="flex justify-between items-center py-4 border-b mb-6">
      <h1 class="text-3xl font-bold text-gray-800">BrandGrip CRM Dashboard</h1>
      <button onclick="openAddLeadModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
        + Add New Lead
      </button>
    </header>

    <section id="dashboard-insights" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      </section>

    <div class="bg-white shadow-lg rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">üîç Leads Management</h2>
        <div class="flex flex-wrap gap-4 mb-4">
            <input type="text" id="search-input" placeholder="Search by Name, Email, or Phone..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <select id="filter-stage" class="p-2 border border-gray-300 rounded-lg">
                <option value="">Filter by Stage</option>
                <option value="New">New</option>
                <option value="Qualified">Qualified</option>
                <option value="Offer Sent">Offer Sent</option>
                <option value="Won">Won</option>
                <option value="Lost">Lost</option>
            </select>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th onclick="sortLeads('Client Name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Client Name</th>
                        <th onclick="sortLeads('Lead Stage')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Stage</th>
                        <th onclick="sortLeads('Next Follow-up Date')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Next Follow-up</th>
                        <th onclick="sortLeads('Days Since Follow-up')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer">Days Since</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="lead-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
            </table>
        </div>
        <div id="pagination-controls" class="mt-4 flex justify-end gap-2">
            </div>
    </div>
  </div>

  <div id="lead-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 transition duration-300" onclick="if(event.target.id === 'lead-modal') closeModal()">
      <div class="relative top-20 mx-auto p-5 border w-4/5 md:w-3/5 lg:w-2/5 shadow-lg rounded-xl bg-white">
          <div class="mt-3 text-center">
              <h3 id="modal-title" class="text-lg leading-6 font-medium text-gray-900 mb-4">Add New Lead</h3>
              
              <form id="lead-form" class="mt-2">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                      <div>
                          <label for="Client Name" class="block text-sm font-medium text-gray-700">Client Name *</label>
                          <input type="text" name="Client Name" id="Client Name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>

                      <div>
                          <label for="Phone" class="block text-sm font-medium text-gray-700">Phone (for WhatsApp) *</label>
                          <input type="tel" name="Phone" id="Phone" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>
                      
                      <div>
                          <label for="Email" class="block text-sm font-medium text-gray-700">Email *</label>
                          <input type="email" name="Email" id="Email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>

                      <div>
                          <label for="Business Type" class="block text-sm font-medium text-gray-700">Business Type</label>
                          <input type="text" name="Business Type" id="Business Type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>
                      
                      <div>
                          <label for="Lead Source" class="block text-sm font-medium text-gray-700">Lead Source</label>
                          <select name="Lead Source" id="Lead Source" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                              <option value="">Select Source</option>
                              <option value="Referral">Referral</option>
                              <option value="Website">Website</option>
                              <option value="Cold Call">Cold Call</option>
                              <option value="Social Media">Social Media</option>
                          </select>
                      </div>

                      <div>
                          <label for="Product Interested" class="block text-sm font-medium text-gray-700">Product Interested</label>
                          <input type="text" name="Product Interested" id="Product Interested" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>
                      
                      <div>
                          <label for="Lead Stage" class="block text-sm font-medium text-gray-700">Lead Stage *</label>
                          <select name="Lead Stage" id="Lead Stage" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border bg-white">
                              <option value="New">New</option>
                              <option value="Qualified">Qualified</option>
                              <option value="Offer Sent">Offer Sent</option>
                              <option value="Won">Won</option>
                              <option value="Lost">Lost</option>
                          </select>
                      </div>

                      <div>
                          <label for="Quoted Price" class="block text-sm font-medium text-gray-700">Quoted Price (Ksh)</label>
                          <input type="number" step="0.01" name="Quoted Price" id="Quoted Price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>

                      <div>
                          <label for="Next Follow-up Date" class="block text-sm font-medium text-gray-700">Next Follow-up Date</label>
                          <input type="date" name="Next Follow-up Date" id="Next Follow-up Date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>

                      <div>
                          <label for="Order Value (Ksh)" class="block text-sm font-medium text-gray-700">Order Value (Ksh)</label>
                          <input type="number" step="0.01" name="Order Value (Ksh)" id="Order Value (Ksh)" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>

                      <div class="md:col-span-2">
                          <label for="Assigned To" class="block text-sm font-medium text-gray-700">Assigned To</label>
                          <input type="text" name="Assigned To" id="Assigned To" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                      </div>
                      
                      <div class="md:col-span-2">
                          <label for="Notes" class="block text-sm font-medium text-gray-700">Notes</label>
                          <textarea name="Notes" id="Notes" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border"></textarea>
                      </div>
                  </div>
                  
                  <div class="flex justify-end gap-4 mt-6">
                      <button type="button" id="delete-btn" onclick="deleteLeadAction(currentLeadId)" class="hidden bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                          Delete Lead
                      </button>
                      <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                          Cancel
                      </button>
                      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                          Save Lead
                      </button>
                  </div>
              </form>
          </div>
      </div>
  </div>


  <script>
    // --- Configuration ---
    // !!! IMPORTANT: Replace this with your actual Apps Script Web App URL !!!
    const API_ENDPOINT = 'https://script.google.com/macros/s/AKfyc.../exec'; 

    // --- Global State ---
    let ALL_LEADS = [];
    let CURRENT_PAGE = 1;
    const LEADS_PER_PAGE = 10;
    let SORT_COLUMN = 'Date Received';
    let SORT_DIRECTION = 'desc';
    let currentLeadId = null;
    
    // --- Element Access ---
    const modal = document.getElementById('lead-modal');
    const form = document.getElementById('lead-form');
    
    // --- API Communication Functions (using standard Fetch) ---

    /** Executes a standard REST API call to the Apps Script endpoint. */
    async function apiCall(method, action, body = null) {
      const url = `${API_ENDPOINT}?action=${action}`;
      
      const options = {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        }
      };
      
      if (body) {
        options.body = JSON.stringify(body);
      }
      
      try {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return await response.json();
      } catch (error) {
        console.error('API Call Failed:', error);
        throw new Error(`Connection Error: ${error.message}. Check the API_ENDPOINT and CORS settings.`);
      }
    }

    // --- Data Fetching and Initialization ---

    async function initDashboard() {
      try {
        showLoading(true);
        // GET request for fetching leads
        const response = await apiCall('GET', 'getLeads');
        
        if (response.success === false) {
             throw new Error(response.data || "Failed to fetch leads.");
        }
        
        ALL_LEADS = response.data || [];
        renderDashboard();
      } catch (e) {
        console.error("Failed to initialize dashboard:", e);
        alert(`Error initializing dashboard: ${e.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    // --- CRUD Operations (API) ---

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {};
        // Use field IDs as keys, which match Sheet Headers
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        const action = currentLeadId ? 'update' : 'add';
        const apiData = currentLeadId ? { id: currentLeadId, data: data } : data;

        try {
            showLoading(true);
            const response = await apiCall('POST', action, apiData);

            if (response.success) {
                alert(`Lead ${action === 'add' ? 'added' : 'updated'} successfully!`);
                closeModal();
                await initDashboard(); // Re-fetch and re-render all data
            } else {
                alert(`Operation failed: ${response.data}`);
            }
        } catch (error) {
            console.error(error);
            alert('An unexpected error occurred during the API call.');
        } finally {
            showLoading(false);
        }
    });

    async function deleteLeadAction(id) {
        if (!confirm('Are you sure you want to delete this lead? This cannot be undone.')) {
            return;
        }

        try {
            showLoading(true);
            const response = await apiCall('POST', 'delete', { id: id });

            if (response.success) {
                alert(`Lead ${id} deleted successfully.`);
                closeModal();
                await initDashboard(); // Re-fetch and re-render all data
            } else {
                alert(`Deletion failed: ${response.data}`);
            }
        } catch (error) {
            console.error(error);
            alert('An unexpected error occurred during deletion.');
        } finally {
            showLoading(false);
        }
    }


    // --- UI/Rendering Functions (Identical to previous version) ---

    function renderDashboard() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const filterStage = document.getElementById('filter-stage').value;

        let filteredLeads = ALL_LEADS.filter(lead => {
            const matchesSearch = !searchTerm || 
                                (lead['Client Name'] && lead['Client Name'].toLowerCase().includes(searchTerm)) ||
                                (lead.Email && lead.Email.toLowerCase().includes(searchTerm)) ||
                                (lead.Phone && String(lead.Phone).includes(searchTerm));
            
            const matchesStage = !filterStage || lead['Lead Stage'] === filterStage;
            
            return matchesSearch && matchesStage;
        });

        // Apply sorting
        filteredLeads.sort((a, b) => {
            const aVal = a[SORT_COLUMN];
            const bVal = b[SORT_COLUMN];

            if (SORT_COLUMN === 'Days Since Follow-up' || SORT_COLUMN === 'Order Value (Ksh)') {
                // Numeric sort
                const valA = parseFloat(aVal) || 0;
                const valB = parseFloat(bVal) || 0;
                return SORT_DIRECTION === 'asc' ? valA - valB : valB - valA;
            } else {
                // String/Date sort
                const valA = String(aVal || '').toLowerCase();
                const valB = String(bVal || '').toLowerCase();
                if (valA < valB) return SORT_DIRECTION === 'asc' ? -1 : 1;
                if (valA > valB) return SORT_DIRECTION === 'asc' ? 1 : -1;
                return 0;
            }
        });

        renderTable(filteredLeads);
        renderPagination(filteredLeads.length);
        renderInsights(filteredLeads);
    }
    
    function renderTable(leads) {
        const tableBody = document.getElementById('lead-table-body');
        tableBody.innerHTML = '';
        
        const start = (CURRENT_PAGE - 1) * LEADS_PER_PAGE;
        const end = start + LEADS_PER_PAGE;
        const leadsToDisplay = leads.slice(start, end);
        
        leadsToDisplay.forEach(lead => {
            const row = tableBody.insertRow();
            row.className = 'hover:bg-gray-50 transition duration-150';

            const getBadgeClass = (stage) => {
                switch (stage) {
                    case 'New': return 'bg-blue-100 text-blue-800';
                    case 'Qualified': return 'bg-yellow-100 text-yellow-800';
                    case 'Offer Sent': return 'bg-indigo-100 text-indigo-800';
                    case 'Won': return 'bg-green-100 text-green-800';
                    case 'Lost': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            };
            
            const getStatusClass = (days) => {
                if (days >= 7) return 'text-red-600 font-bold';
                if (days >= 3) return 'text-yellow-600';
                return 'text-green-600';
            };

            const daysSince = lead['Days Since Follow-up'] || 0;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${lead['Client Name']} <br>
                    <span class="text-xs text-gray-500">${lead.Email}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getBadgeClass(lead['Lead Stage'])}">
                        ${lead['Lead Stage']}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lead['Next Follow-up Date'] || 'N/A'}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm ${getStatusClass(daysSince)}">${daysSince} days</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="openEditLeadModal('${lead['Lead ID']}')" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button onclick="deleteLeadAction('${lead['Lead ID']}')" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            `;
        });
    }

    function sortLeads(column) {
        if (SORT_COLUMN === column) {
            SORT_DIRECTION = SORT_DIRECTION === 'asc' ? 'desc' : 'asc';
        } else {
            SORT_COLUMN = column;
            SORT_DIRECTION = 'asc';
        }
        CURRENT_PAGE = 1; 
        renderDashboard();
    }
    
    document.getElementById('search-input').addEventListener('input', () => {
        CURRENT_PAGE = 1;
        renderDashboard();
    });
    document.getElementById('filter-stage').addEventListener('change', () => {
        CURRENT_PAGE = 1;
        renderDashboard();
    });

    function renderPagination(totalLeads) {
        const totalPages = Math.ceil(totalLeads / LEADS_PER_PAGE);
        const controls = document.getElementById('pagination-controls');
        controls.innerHTML = '';
        
        const createButton = (text, page, isDisabled) => {
            const button = document.createElement('button');
            button.innerText = text;
            button.className = `py-2 px-3 border rounded-lg text-sm transition duration-150 ${
                isDisabled 
                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                    : 'bg-white text-gray-700 hover:bg-gray-200'
            }`;
            button.disabled = isDisabled;
            button.onclick = () => {
                CURRENT_PAGE = page;
                renderDashboard();
            };
            return button;
        };
        
        controls.appendChild(createButton('Previous', CURRENT_PAGE - 1, CURRENT_PAGE === 1));
        
        const pageIndicator = document.createElement('span');
        pageIndicator.innerText = `Page ${CURRENT_PAGE} of ${totalPages}`;
        pageIndicator.className = 'py-2 px-3 text-sm text-gray-700';
        controls.appendChild(pageIndicator);

        controls.appendChild(createButton('Next', CURRENT_PAGE + 1, CURRENT_PAGE === totalPages));
    }

    function renderInsights(leads) {
        const container = document.getElementById('dashboard-insights');
        container.innerHTML = '';

        let totalLeads = leads.length;
        let leadsPerStage = {};
        let revenueProjection = 0;
        
        leads.forEach(lead => {
            const stage = lead['Lead Stage'] || 'Unknown';
            leadsPerStage[stage] = (leadsPerStage[stage] || 0) + 1;
            
            const quotedPrice = parseFloat(lead['Quoted Price']) || 0;
            if (stage === 'Offer Sent') {
                revenueProjection += quotedPrice * 0.5;
            } else if (stage === 'Won') {
                revenueProjection += parseFloat(lead['Order Value (Ksh)']) || quotedPrice;
            }
        });

        const insights = [
            { title: 'Total Active Leads', value: totalLeads, color: 'blue', icon: 'üë§' },
            { title: 'Leads at Offer Stage', value: leadsPerStage['Offer Sent'] || 0, color: 'indigo', icon: 'üìù' },
            { title: 'Revenue Projection (Ksh)', value: `Ksh ${revenueProjection.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`, color: 'green', icon: 'üí∞' },
            { title: 'Leads Lost', value: leadsPerStage['Lost'] || 0, color: 'red', icon: '‚ùå' },
        ];

        insights.forEach(item => {
            container.innerHTML += `
                <div class="bg-white shadow-md rounded-xl p-5 border-l-4 border-${item.color}-500 transition duration-300 hover:shadow-lg">
                    <p class="text-sm font-medium text-gray-500">${item.title}</p>
                    <p class="text-2xl font-bold text-gray-800 mt-1">${item.value} <span class="text-lg">${item.icon}</span></p>
                </div>
            `;
        });
    }

    // --- Modal Handlers ---

    function openAddLeadModal() {
        currentLeadId = null;
        form.reset();
        document.getElementById('modal-title').innerText = 'Add New Lead';
        document.getElementById('delete-btn').classList.add('hidden');
        modal.classList.remove('hidden');
    }

    function openEditLeadModal(id) {
        const lead = ALL_LEADS.find(l => String(l['Lead ID']) === String(id));
        if (!lead) return;

        currentLeadId = id;
        document.getElementById('modal-title').innerText = `Edit Lead: ${lead['Client Name']}`;
        document.getElementById('delete-btn').classList.remove('hidden');
        
        // Populate form fields dynamically using Sheet Headers as IDs
        const headers = [
            'Client Name', 'Phone', 'Email', 'Business Type', 'Lead Source', 
            'Product Interested', 'Lead Stage', 'Quoted Price', 
            'Next Follow-up Date', 'Order Value (Ksh)', 'Assigned To', 'Notes'
        ];
        
        headers.forEach(header => {
            const element = document.getElementById(header);
            if (element) {
                element.value = lead[header] || '';
            }
        });

        modal.classList.remove('hidden');
    }

    function closeModal() {
        modal.classList.add('hidden');
        form.reset();
        currentLeadId = null;
    }

    function showLoading(show) {
      document.body.style.cursor = show ? 'wait' : 'default';
      // Implement a better loading spinner here if desired
    }

    // Initialize the dashboard when the page loads
    window.onload = initDashboard;
  </script>
</body>
</html>